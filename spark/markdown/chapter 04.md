# chapter 04
spark æ ¸å¿ƒç¼–ç¨‹ = RDD + ç´¯åŠ å™¨ + å¹¿æ’­å˜é‡

+ ç´¯åŠ å™¨

åˆ†å¸ƒå¼å…±äº«åªå†™å˜é‡

+ å¹¿æ’­å˜é‡

åˆ†å¸ƒå¼å…±äº«åªè¯»å˜é‡

## RDD

Driver ä¸ Executor çš„é€šä¿¡:

ä»£ç åœ¨ package test

ç®€å•æ¨¡æ‹Ÿåˆ†å¸ƒå¼è®¡ç®—:

ä»£ç åœ¨ package test2

stack.scala ç›¸å½“äºæ•°æ®ç»“æ„æ¡†æ¶, subtask.scala æ˜¯çœŸÂ·task

+ RDD

å¼¹æ€§åˆ†å¸ƒå¼æ•°æ®é›†

+ å¼¹æ€§
    1. å­˜å‚¨ï¼šå†…å­˜ä¸ç£ç›˜çš„è‡ªåŠ¨åˆ‡æ¢
    2. å®¹é”™ï¼šæ•°æ®ä¸¢å¤±å¯ä»¥è‡ªåŠ¨æ¢å¤
    3. è®¡ç®—ï¼šè®¡ç®—å‡ºé”™é‡è¯•æœºåˆ¶
    4. åˆ†ç‰‡ï¼ˆåˆ†åŒºï¼‰ï¼šæ ¹æ®éœ€è¦é‡æ–°åˆ†ç‰‡
    
+ åˆ†å¸ƒå¼

æ•°æ®å­˜å‚¨åœ¨å¤§æ•°æ®é›†ç¾¤ä¸åŒèŠ‚ç‚¹ä¸Š

+ æ•°æ®é›†

RDD å°è£…äº†è®¡ç®—çš„é€»è¾‘ï¼Œä¸å­˜å‚¨æ•°æ®

+ æ•°æ®æŠ½è±¡

RDD æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œéœ€è¦å­ç±»å…·ä½“å®ç°

+ ä¸å¯å˜

RDD å°è£…çš„è®¡ç®—é€»è¾‘ä¸èƒ½å‘ç”Ÿæ”¹å˜

+ å¯åˆ†åŒº å¹¶è¡Œè®¡ç®—

+ Others

RDD æ˜¯æœ€å°è®¡ç®—å•å…ƒï¼Œé€»è¾‘ä¸èƒ½å¤ªå¤æ‚ï¼Œä»¥ä¾¿èƒ½å¤ç”¨

Driver å°†ä»»åŠ¡åˆ†æˆå¤šä¸ª task( = **RDD** + åˆ†é…çš„èµ„æº ) åˆ†é…ç»™ä¸åŒçš„ executor

RDD çš„æ•°æ®å¤„ç†æ–¹å¼ç±»ä¼¼äº IO æµï¼Œä¹Ÿæœ‰è£…é¥°è€…æ¨¡å¼

RDD çš„æ•°æ®åªæœ‰åœ¨è°ƒç”¨ collect æ–¹æ³•æ—¶æ‰ä¼šçœŸæ­£æ‰§è¡Œä¸šåŠ¡é€»è¾‘æ“ä½œï¼Œä¹‹å‰çš„æ“ä½œåªæ˜¯åœ¨å®šä¹‰

RDD æ˜¯ä¸ä¿å­˜æ•°æ®çš„ï¼Œä½† IO æœ‰ buffer å¯ä»¥ä¸´æ—¶ä¿å­˜æ•°æ®

+ æ ¸å¿ƒå±æ€§
    1. åˆ†åŒºåˆ—è¡¨ï¼Œå¹¶è¡Œè®¡ç®—
    2. æ¯ä¸ªåˆ†åŒºéƒ½æœ‰è®¡ç®—ï¼ˆç›¸åŒçš„è®¡ç®—é€»è¾‘ï¼‰
    3. RDD æœ‰ 0 ä¸ªæˆ–å¤šä¸ª dependency
    4. åˆ†åŒºå™¨ å°†æ•°æ®åˆ†åŒºçš„å·¥å…·
    5. åœ¨æ¯ä¸ªåˆ†åŒºè®¡ç®—æ—¶éƒ½æœ‰ä¸€ä¸ªé¦–é€‰çš„ä½ç½®ï¼ˆ æ‰¾æ•ˆç‡æœ€ä¼˜çš„ executor ï¼‰ï¼Œç§»åŠ¨æ•°æ®ä¸å¦‚ç§»åŠ¨è®¡ç®—
    

+ æ‰§è¡ŒåŸç†

## åŸºç¡€ç¼–ç¨‹

+ RDD åˆ›å»º: package rdd.builder
    1. ä»å†…å­˜ï¼ˆé›†åˆï¼‰ä¸­åˆ›å»º â€»
    2. ä»å¤–éƒ¨å­˜å‚¨æ–‡ä»¶åˆ›å»º â€»
    3. ä»å…¶ä»– RDD åˆ›å»º
    4. ç›´æ¥åˆ›å»º
  
3 å’Œ 4 ä¸€èˆ¬åœ¨æºç é‡Œä½¿ç”¨ï¼Œä»£ç ä¸­ä¸€èˆ¬ç”¨ 1 å’Œ 2
  
+ RDD çš„å¹¶è¡Œåº¦å’Œåˆ†åŒº

package rdd.builder xxxPar.scala

### RDD æ–¹æ³•
+ RDD æ–¹æ³• => RDD ç®—å­

1. è½¬æ¢ï¼šåŠŸèƒ½çš„è¡¥å……å’Œå°è£…ï¼Œæ—§çš„ RDD åŒ…è£…æˆæ–°çš„ RDDï¼Œå¦‚ map flatMap
2. è¡ŒåŠ¨ï¼šè§¦å‘ä»»åŠ¡çš„è°ƒåº¦å’Œä½œä¸šçš„æ‰§è¡Œï¼Œå¦‚ collect
  

#### RDD è½¬æ¢ç®—å­

ä»£ç  package rdd.operator.transform

##### value ç±»å‹

1. map è½¬æ¢æ˜ å°„

2. mapPartitions

3. mapPartitionsWithIndex èƒ½çœ‹åˆ°åˆ†åŒºç¼–å·

4. flatMap

5. glom

6. groupBy

7. filter

8. sample

9. distinct

10. coalesce

11. repartition

12. sortBy

##### åŒ value ç±»å‹

13. intersection

14. union

15. subtract

16. zip

##### key - value ç±»å‹

17. partitionBy

18. reduceByKey

19. groupByKey

ä» shuffle çš„è§’åº¦: reduceByKey å’Œ groupByKey éƒ½å­˜åœ¨ shuffle çš„æ“ä½œï¼Œä½†æ˜¯ reduceByKey å¯ä»¥åœ¨ shuffle å‰å¯¹åˆ†åŒºå†…ç›¸åŒ key çš„æ•°æ®è¿›è¡Œé¢„èšåˆ(combine)åŠŸèƒ½ï¼Œè¿™æ ·ä¼šå‡å°‘è½ç›˜çš„æ•°æ®é‡ï¼Œè€Œ groupByKey åªæ˜¯è¿›è¡Œåˆ†ç»„ï¼Œä¸å­˜åœ¨æ•°æ®é‡å‡å°‘çš„é—®é¢˜ï¼ŒreduceByKey æ€§èƒ½æ›´é«˜ã€‚

ä»åŠŸèƒ½çš„è§’åº¦: reduceByKey å…¶å®åŒ…å«åˆ†ç»„å’Œèšåˆçš„åŠŸèƒ½ã€‚GroupByKey åªèƒ½åˆ†çº½ï¼Œä¸èƒ½èšåˆï¼Œæ‰€ä»¥åœ¨åˆ†ç»„èšåˆçš„åœºåˆä¸‹ï¼Œæ¨èä½¿ç”¨ reduceByKeyï¼Œå¦‚æœä»…ä»…æ˜¯åˆ†ç»„è€Œä¸éœ€è¦èšåˆï¼Œé‚£ä¹ˆè¿˜æ˜¯åªèƒ½ä½¿ç”¨ groupByKeyã€‚

20. aggregateByKey

21. foldByKey

22. combineByKey

23. join

24. leftOuterJoin rightOuterJoin

25. cogroup

#### RDD è¡ŒåŠ¨ç®—å­

è¡ŒåŠ¨ç®—å­ï¼šè§¦å‘ä½œä¸šæ‰§è¡Œçš„æ–¹æ³•ï¼Œåº•å±‚è°ƒç”¨çš„æ˜¯ç¯å¢ƒå¯¹è±¡çš„ runJob æ–¹æ³•

åº•å±‚ä»£ç ä¸­ä¼šåˆ›å»º ActiveJobï¼Œå¹¶æäº¤æ‰§è¡Œ

1. reduce

2. collect

3. count

4. first

5. take

6. takeOrdered

7. aggregate

8. fold

9. countByValue countByKey

wordcount çš„å¤šç§å®ç°æ–¹å¼ï¼špackage wordcount.Spark04_WordCount

10. save

11. foreach

### RDD åºåˆ—åŒ–

+ é—­åŒ…æ£€æµ‹ï¼šæ£€æŸ¥æ˜¯å¦åºåˆ—åŒ–äº†

+ Kryo åºåˆ—åŒ–æ¡†æ¶

é€Ÿåº¦æ˜¯ Serializable çš„åå€

å½“ RDD åœ¨ Shuffle æ•°æ®çš„æ—¶å€™ï¼Œç®€å•æ•°æ®ç±»å‹ã€æ•°ç»„å’Œå­—ç¬¦ä¸²ç±»å‹å·±ç»åœ¨ Spark å†…éƒ¨ä½¿ç”¨ Kryo æ¥åºåˆ—åŒ–

å†…éƒ¨å°±æ˜¯è¿™ä¹ˆåšçš„ï¼Œä¸ç”¨è‡ªå·±å†™ ğŸ˜‚

### RDD ä¾èµ–å…³ç³»

ä»£ç ï¼špackage rdd.dep

ç¦æ­¢ç¯å½¢ä¾èµ–

æ¯ä¸ª RDD éƒ½ä¼šä¿å­˜è¡€ç¼˜å…³ç³»

ä¸€æ—¦å‡ºç°é”™è¯¯ï¼Œå¯ä»¥æ ¹æ®è¡€ç¼˜å…³ç³»å°†æ•°æ®æºé‡æ–°è¯»å–è¿›è¡Œè®¡ç®—

OneToOne(çª„) ä¾èµ– & shuffle(å®½) ä¾èµ–

rdd çœ‹ä¼¼æ˜¯ä»å‰å¾€åæ‰§è¡Œçš„ï¼Œå®é™…ä¸Šæ˜¯å…ˆè°ƒç”¨åè¾¹çš„ rddï¼Œå†ä¸€å±‚ä¸€å±‚é€’å½’è®¡ç®—å‰è¾¹çš„ rdd

+ åˆ’åˆ†é˜¶æ®µ Stage

éœ€è¦ shuffle çš„åœ°æ–¹ï¼Œå¿…é¡»ç­‰å¾…ç›¸å…³ rdd éƒ½æ‰§è¡Œå®Œï¼Œå› ä¸ºè¦é‡æ–°åˆ†åŒº

+ ä»»åŠ¡åˆ’åˆ†

Application(SparkContext) -> Job( Action ç®—å­ ) -> Stage(shuffleDependency çš„ä¸ªæ•° + 1) -> Task(ä¸€ä¸ª Stage é˜¶æ®µä¸­ï¼Œæœ€åä¸€ä¸ª RDD çš„åˆ†åŒºä¸ªæ•°å°±æ˜¯ Task çš„ä¸ªæ•°)

æ¯ä¸€å±‚éƒ½æ˜¯ 1 å¯¹ å¤š

![img.png](images/img5.png)

### RDD æŒä¹…åŒ–

ä»£ç ï¼špackage rdd.persist

+ RDD CheckPoint æ£€æŸ¥ç‚¹

### RDD åˆ†åŒºå™¨

ä»£ç ï¼špackage rdd.partition

è‡ªå®šä¹‰åˆ†åŒºå™¨:
1. ç»§æ‰¿ Partitioner
2. é‡å†™æ–¹æ³•

### RDD æ–‡ä»¶è¯»å–ä¸ä¿å­˜

ä»£ç ï¼špackage rdd.io